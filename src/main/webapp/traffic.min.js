var GrenobleTraffic={version:1,polylines:{},refreshTrafficStatus:function(a){GrenobleTraffic.replaceText(a.date);a.features.forEach(function(a){var c="#045FB4",d;switch(a.properties.NSV_ID){case 1:c="#73BB02";d=100;break;case 2:c="#FFBF00";d=50;break;case 3:c="#DD1717";d=25;break;case 4:c="#000000",d=10}GrenobleTraffic.drawTroncon(a.properties.CODE,c,0.7,4,d)});GrenobleTraffic.refreshDiv&&(GrenobleTraffic.refreshDiv.className="gmap-control")},drawTroncon:function(a,b,c,d,e){var f=GrenobleTraffic.loadCoords(a),
b=new google.maps.Polyline({path:f,strokeColor:b,strokeOpacity:c,strokeWeight:d,zIndex:e,strokeWeight:d});GrenobleTraffic.polylines[a]&&GrenobleTraffic.polylines[a].setMap(null);GrenobleTraffic.polylines[a]=b;b.setMap(GrenobleTraffic.map)},fetchTrafficInfos:function(){var a=new XMLHttpRequest;a.onreadystatechange=function(){4==a.readyState&&(200==a.status?GrenobleTraffic.refreshTrafficStatus(JSON.parse(a.responseText)):console.log("Error: returned status code "+a.status+" "+a.statusText))};a.open("GET",
"traffic",!0);a.send(null)},loadCoords:function(a){var b=[],c=0;if(c=localStorage[a]){a=JSON.parse(c);for(c=0;c<a.length;c++){var d=a[c];b.push(new google.maps.LatLng(d[1],d[0]));c++}}return b},storeTroncon:function(a){localStorage[a.properties.CODE]=JSON.stringify(a.geometry.coordinates[0])},refreshTroncons:function(a){localStorage.version=GrenobleTraffic.version;a.features.forEach(GrenobleTraffic.storeTroncon);GrenobleTraffic.fetchTrafficInfos()},fetchTroncons:function(){localStorage.clear();var a=
new XMLHttpRequest;a.onreadystatechange=function(){4==a.readyState&&(200==a.status?GrenobleTraffic.refreshTroncons(JSON.parse(a.responseText)):console.log("Error: returned status code "+a.status+" "+a.statusText))};a.open("GET","troncons.json",!0);a.send(null)},addControl:function(a,b){var c=document.createElement("DIV");c.className="gmap-control-container gmnoprint";var d=document.createElement("DIV");d.className="gmap-control";var e=document.createElement("i");e.className="icon icon-"+a;d.appendChild(e);
c.appendChild(d);google.maps.event.addDomListener(d,"click",function(){d.className="gmap-control gmap-control-active";b()});GrenobleTraffic.map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(c);return d},replaceText:function(a){GrenobleTraffic.map.controls[google.maps.ControlPosition.BOTTOM_CENTER].clear();var b=document.createElement("span");b.id="lastUpdateDate";b.className="badge badge-info";b.innerText=a;GrenobleTraffic.map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(b)},
switchTheme:function(){var a;switch(GrenobleTraffic.currentTheme){case "b&w":a=0;GrenobleTraffic.currentTheme="color";GrenobleTraffic.switchThemeDiv.className="gmap-control";break;default:a=-100,GrenobleTraffic.currentTheme="b&w",GrenobleTraffic.switchThemeDiv.className="gmap-control gmap-control-active"}GrenobleTraffic.map.setOptions({styles:[{stylers:[{saturation:a}]}]})},start:function(){var a={center:new google.maps.LatLng(45.182037,5.727654),zoom:13,overviewMapControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,
panControl:!1,streetViewControl:!1,mapTypeControl:!1,mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER}};GrenobleTraffic.map=new google.maps.Map(document.getElementById("mapCanvas"),a);GrenobleTraffic.refreshDiv=GrenobleTraffic.addControl("refresh",GrenobleTraffic.fetchTrafficInfos);GrenobleTraffic.switchThemeDiv=GrenobleTraffic.addControl("adjust",GrenobleTraffic.switchTheme);GrenobleTraffic.switchTheme();
navigator.geolocation?navigator.geolocation.getCurrentPosition(GrenobleTraffic.setPosition,GrenobleTraffic.onPositionError):console.log("No support for geolocation on this device");GrenobleTraffic.version!=localStorage.version?(console.log("refreshing local data with new troncons from server"),setTimeout(GrenobleTraffic.fetchTroncons,200)):GrenobleTraffic.fetchTrafficInfos()},setPosition:function(a){a=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);GrenobleTraffic.map.panTo(a);marker=
new google.maps.Marker({map:GrenobleTraffic.map,icon:new google.maps.MarkerImage("marker.png",new google.maps.Size(20,28)),draggable:!1,animation:google.maps.Animation.DROP,position:a})},onPositionError:function(a){var b="Error geolocating user : ";switch(a.code){case a.TIMEOUT:b+="timeout";break;case a.PERMISSION_DENIED:b+="permission denied";break;case a.POSITION_UNAVAILABLE:b+="not able to determine position";break;case a.UNKNOWN_ERROR:b+="unknown error"}console.log(b)}};