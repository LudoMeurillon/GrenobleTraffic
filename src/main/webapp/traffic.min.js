var GrenobleTraffic={version:2,tronconsByCode:[],tronconsJsonFile:"troncons.json",common:{}};GrenobleTraffic.common.getJson=function(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){4==c.readyState&&(200==c.status?b(JSON.parse(c.responseText)):console.log("Error: returned status code "+c.status+" "+c.statusText))};c.open("GET",a,!0);c.send(null)};GrenobleTraffic.stationmobile={};
GrenobleTraffic.stationmobile.refreshStationMobile=function(){GrenobleTraffic.version!=localStorage.version?(console.log("refreshing local data with new troncons from server"),setTimeout(GrenobleTraffic.stationmobile.fetchTroncons,200)):GrenobleTraffic.stationmobile.fetchTrafficInfos()};GrenobleTraffic.stationmobile.fetchTrafficInfos=function(){GrenobleTraffic.common.getJson("traffic",function(a){GrenobleTraffic.graphic.refreshTrafficStatus(a)})};
GrenobleTraffic.stationmobile.fetchTroncons=function(){localStorage.clear();GrenobleTraffic.common.getJson(GrenobleTraffic.tronconsJsonFile,function(a){localStorage.version=GrenobleTraffic.version;localStorage[GrenobleTraffic.tronconsJsonFile]=JSON.stringify(a);GrenobleTraffic.fetchTrafficInfos()})};
GrenobleTraffic.stationmobile.readTroncons=function(){var a=JSON.parse(localStorage[GrenobleTraffic.tronconsJsonFile]);if(a)for(var b=0;b<a.features.length;b++)GrenobleTraffic.tronconsByCode[a.features[b].properties.CODE]=a.features[b].geometry.coordinates[0]};GrenobleTraffic.graphic={};GrenobleTraffic.graphic.polylines={};
GrenobleTraffic.graphic.drawTroncon=function(a,b,c,d,e){var f=GrenobleTraffic.graphic.loadCoords(a),b=new google.maps.Polyline({path:f,strokeColor:b,strokeOpacity:c,strokeWeight:d,zIndex:e,strokeWeight:d});GrenobleTraffic.graphic.polylines[a]&&GrenobleTraffic.graphic.polylines[a].setMap(null);GrenobleTraffic.graphic.polylines[a]=b;b.setMap(GrenobleTraffic.graphic.map)};
GrenobleTraffic.graphic.loadCoords=function(a){var b=[],c=0;if(a=GrenobleTraffic.tronconsByCode[a])for(c=0;c<a.length;c++){var d=a[c];b.push(new google.maps.LatLng(d[1],d[0]));c++}return b};
GrenobleTraffic.graphic.refreshTrafficStatus=function(a){GrenobleTraffic.graphic.replaceText(a.date);GrenobleTraffic.stationmobile.readTroncons();a.features.forEach(function(a){var c="#045FB4";switch(a.properties.NSV_ID){case 1:c="#73BB02";break;case 2:c="#FFBF00";break;case 3:c="#DD1717";break;case 4:c="#000000"}GrenobleTraffic.graphic.drawTroncon(a.properties.CODE,c,0.7,4,a.properties.NSV_ID)});GrenobleTraffic.graphic.refreshDiv&&(GrenobleTraffic.graphic.refreshDiv.className="gmap-control")};
GrenobleTraffic.graphic.createIcon=function(a,b){var c=document.createElement("DIV");c.className="gmap-control";var d=document.createElement("i");d.className="icon icon-"+a;c.appendChild(d);google.maps.event.addDomListener(c,"click",function(){c.className="gmap-control gmap-control-active";b()});return c};
GrenobleTraffic.graphic.initControls=function(){GrenobleTraffic.graphic.refreshDiv=GrenobleTraffic.graphic.createIcon("refresh",GrenobleTraffic.stationmobile.fetchTrafficInfos);GrenobleTraffic.graphic.switchThemeDiv=GrenobleTraffic.graphic.createIcon("adjust",GrenobleTraffic.graphic.switchTheme);var a=document.createElement("DIV");a.className="gmap-control-container gmnoprint";a.appendChild(GrenobleTraffic.graphic.refreshDiv);a.appendChild(GrenobleTraffic.graphic.switchThemeDiv);GrenobleTraffic.graphic.map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a);
GrenobleTraffic.graphic.setPositionDiv=GrenobleTraffic.graphic.createIcon("map-marker",GrenobleTraffic.geolocation.refreshPosition);a=document.createElement("DIV");a.className="gmap-control-container gmnoprint";a.appendChild(GrenobleTraffic.graphic.setPositionDiv);GrenobleTraffic.graphic.map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(a)};
GrenobleTraffic.graphic.replaceText=function(a){GrenobleTraffic.graphic.map.controls[google.maps.ControlPosition.BOTTOM_CENTER].clear();var b=document.createElement("span");b.id="lastUpdateDate";b.className="badge badge-info";b.innerText=a;GrenobleTraffic.graphic.map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(b)};
GrenobleTraffic.graphic.switchTheme=function(){var a;switch(GrenobleTraffic.graphic.currentTheme){case "b&w":a=0;GrenobleTraffic.graphic.currentTheme="color";GrenobleTraffic.graphic.switchThemeDiv.className="gmap-control";break;default:a=-100,GrenobleTraffic.graphic.currentTheme="b&w",GrenobleTraffic.graphic.switchThemeDiv.className="gmap-control gmap-control-active"}GrenobleTraffic.graphic.map.setOptions({styles:[{stylers:[{saturation:a}]}]})};
GrenobleTraffic.start=function(){var a={center:new google.maps.LatLng(45.182037,5.727654),zoom:13,overviewMapControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:!1,streetViewControl:!1,mapTypeControl:!1,mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER}};GrenobleTraffic.graphic.map=new google.maps.Map(document.getElementById("mapCanvas"),a);GrenobleTraffic.graphic.initControls();GrenobleTraffic.graphic.switchTheme();
GrenobleTraffic.geolocation.refreshPosition();GrenobleTraffic.stationmobile.refreshStationMobile()};GrenobleTraffic.geolocation={};GrenobleTraffic.geolocation.refreshPosition=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(GrenobleTraffic.geolocation.setPosition,GrenobleTraffic.geolocation.onPositionError):console.log("No support for geolocation on this device");GrenobleTraffic.graphic.setPositionDiv.className="gmap-control"};
GrenobleTraffic.geolocation.setPosition=function(a){a=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);GrenobleTraffic.graphic.map.panTo(a);GrenobleTraffic.graphic.marker||(GrenobleTraffic.graphic.marker=new google.maps.Marker({map:GrenobleTraffic.graphic.map,icon:new google.maps.MarkerImage("marker.png",new google.maps.Size(20,28)),draggable:!1,animation:google.maps.Animation.DROP,position:a}));GrenobleTraffic.graphic.marker.setPosition(a)};
GrenobleTraffic.geolocation.onPositionError=function(a){var b="Error geolocating user : ";switch(a.code){case a.TIMEOUT:b+="timeout";break;case a.PERMISSION_DENIED:b+="permission denied";break;case a.POSITION_UNAVAILABLE:b+="not able to determine position";break;case a.UNKNOWN_ERROR:b+="unknown error"}console.log(b)};